### 视觉交互 TODO（Metaball + 种子/fork/merge）

> 目标：以 Metaball（隐式场/平滑并集近似）实现“液态融合”的核心体验，并提供三提示词操作：正 / 反 / 合（无“止”）。保留现有 Shader Park 风格（fbm 着色、呼吸、交互平滑）。

---

## 一、里程碑划分（建议）

- Phase 1（MVP：2–3 周）：
  - [ ] 平滑并集近似实现 Metaball（N 球体平滑并集，k 可调）
  - [ ] 基础种子系统（确定性 seed → 位置/相位/半径/权重）
  - [ ] fork：新增单个/一簇场源的交互与状态管理
  - [ ] merge：位置靠拢 + 权重过渡的液态融合（基础版）
  - [ ] 参数面板：T/k/N/种子导入导出（JSON）

- Phase 2（增强：2–3 周）：
  - [ ] 三提示词映射（正/反/合）的参数编舞与回弹曲线
  - [ ] Voronoi 风格边界（仅视觉叠加，用于 rim light/调色）
  - [ ] 表面细节：fbm 频段/相位随交互微调（呼吸感）
  - [ ] 自适应策略：随 N/密度/帧时动态微调 T、k、分辨率

- Phase 3（优化：2–3 周）：
  - [ ] 隐式场步进（实验开关）：更精确的等值面渲染路径
  - [ ] 性能与稳定性：迭代上限/裁剪/源排序/远端降级
  - [ ] 监控面板：FPS/帧时/活跃源数/N 限制/降级状态

---

## 二、核心任务清单（实现级）

### A. Metaball 几何与渲染
- [ ] 选择 MVP 几何路径：
  - [ ] 平滑并集近似（默认）
  - [ ] 隐式场步进（实验开关）
- [ ] 参数：
  - [ ] 阈值 T（0.35–0.65）
  - [ ] 平滑系数 k（0.1–0.6）
  - [ ] 最大源数 N（桌面≤40，移动≤15）
- [ ] 颜色与质感：
  - [ ] 保留 fbm(n) 着色通道
  - [ ] 点击/悬停对频段/相位微调，形成呼吸与压感

### B. 种子系统（可复现/可嫁接）
- [ ] 种子 Schema（JSON）：
  - `seed: uint32`, `weight: number`, `radius: number`, `phase: number`
  - `basePosition: [x,y,z]`
  - 可选：`parentIds: string[]`, `summaryHash: string`
- [ ] PRNG 协议（确定性）：hash(seed) → 伪随机 → 属性映射域
- [ ] 导入/导出：
  - [ ] 导出当前活动种子列表（JSON）
  - [ ] 导入并复现同一布局与动态

### C. 交互（fork / merge / 拖拽）
- [ ] fork：
  - [ ] 新增单个/一簇种子（同母种子派生），立即加入场强求和
  - [ ] 位置初始化策略（镜像/随机/相对鼠标）
- [ ] merge：
  - [ ] 位置靠拢动画 + 权重互注（短时提升 k 或微降 T 再回落）
  - [ ] 边界消隐与“表面张力”观感调参
- [ ] 拖拽：
  - [ ] React 层更新中心 cᵢ，Shader 以 input() 接收
  - [ ] 磁吸与距离衰减（可选）

### D. 三提示词（正 / 反 / 合）
- [ ] 正：
  - [ ] 提高某簇 weight / 降 T / 降 k（更锐/更鼓）
  - [ ] 或沿法线外鼓的位移动画
- [ ] 反：
  - [ ] 相位反转/镜像/负向权重注入（抑制或对冲）
  - [ ] 形成“相消/对峙”的形变与调色
- [ ] 合：
  - [ ] 靠拢 + 小幅增 k / 微降 T，随后缓慢回落至稳态
  - [ ] 形成“贴附-延展-稳定”的液态融合

### E. 自适应与降级
- [ ] 质量自适应：
  - [ ] 帧时>22ms：优先降分辨率/减少活跃源/降低 k
  - [ ] N 或密度升高：自动微调 T 与 k 保持观感一致
- [ ] 平台差异：
  - [ ] 桌面/移动不同默认 N/T/k
  - [ ] GPU 能力探测与预设方案切换

### F. 监控与调试
- [ ] 监控项：FPS、帧时、活跃源数、k/T、降级状态
- [ ] 快捷键/面板：切换渲染路径、显示等值面线框（可选）
- [ ] 日志：fork/merge 操作与种子导入导出记录

---

## 三、参数与数据约定

- 全局参数：
  - `threshold T`：等值面阈值，决定厚薄/连通
  - `smooth k`：平滑并集系数，决定“液态”程度
  - `maxSources N`：上限；自适应可临时下调

- 种子默认映射域：
  - 位置：[-L, L]^3 立方体内（L 依据镜头/画布设定）
  - 半径/权重：分段或对数映射，保障动态范围
  - 相位：0–2π，驱动低频摆动与纹理相移

- 交互映射：
  - `hover`：轻度提高 k、细微相位震荡（呼吸）
  - `click`：短时降低 T 或提高 weight（更稠/更鼓）

---

## 四、验收标准（可量化）

- 视觉与动画：
  - [ ] 两簇靠拢时等值面连通，边界无明显锐缝
  - [ ] fork 注入后 1 帧内出现新“鼓包”，不闪烁
  - [ ] 正/反/合 三操作具备可感知、可复现的稳定效果

- 性能：
  - [ ] 桌面 N=30 时 ≥45 FPS；移动 N=12 时 ≥30 FPS
  - [ ] 降级策略触发后帧时恢复至目标阈值±10%

- 可复现性：
  - [ ] 同一 JSON 导入在不同设备获得等价布局与动态
  - [ ] 相同种子序列多次导入差异<1px（摄像机不变）

---

## 五、风格与一致性

- 保留：
  - [ ] fbm 噪声着色与呼吸节律
  - [ ] 交互平滑（指数平滑/缓动）
- 叠加：
  - [ ] Voronoi 风格边界作为视觉后处理（非几何边界）

---

## 六、风险与预案

- 风险：
  - [ ] 光线步进版本实现复杂度较高（标记为实验开关）
  - [ ] 移动端性能波动，GPU/浏览器差异大
  - [ ] T/k 在不同 N 下的观感漂移
- 预案：
  - [ ] 保底用平滑并集近似；允许一键回退
  - [ ] 自适应降级：N、分辨率、k、迭代步数
  - [ ] 参数正则化：随 N/密度微调 T、k

---

## 七、后续扩展（选做）

- [ ] 物理感增强：表面张力/粘度的视觉化参数
- [ ] 音频驱动：谱段映射到权重/相位/阈值
- [ ] 触觉映射：触控压力/面积与 T/k/weight 绑定

---

## 八、参考映射：三提示词（正 / 反 / 合）

- 正：强调/扩张 → `↑weight | ↓T | ↓k`，或法线外鼓
- 反：对冲/相消 → 相位反转/镜像/负向注入
- 合：连通/消隐 → 靠拢 + `↑k`（短时）+ `↓T`（轻度）→ 回落


