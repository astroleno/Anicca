# Phase 6: SDF Smooth Union å®æ–½æ¸…å•

**ç›®æ ‡**ï¼šè¾¾æˆ"ç£¨ç ‚éº»è–¯è´¨æ„Ÿ"çš„ Metaball + ChatUI è”åŠ¨æ•ˆæœ

**é¢„è®¡æ—¶é—´**ï¼š2-3 å°æ—¶æ ¸å¿ƒæ”¹é€  + 1-2 å°æ—¶è°ƒä¼˜

**çŠ¶æ€**ï¼šğŸ”´ æœªå¼€å§‹

---

## ğŸ¯ æœ€ç»ˆéªŒæ”¶æ ‡å‡†

å®Œæˆåå¿…é¡»æ»¡è¶³ä»¥ä¸‹æ‰€æœ‰æ¡ä»¶ï¼š

### è´¨é‡æ ‡å‡†
- [ ] **æ— ç‚¹çŠ¶ç¯å¸¦**ï¼šæ å°„è§’ã€è–„å£³å¤„è¿ç»­æ— æ–­è£‚ï¼Œæ”¾å¤§ 200% çœ‹ä¸åˆ°é”¯é½¿çŠ¶ç¼ºå£
- [ ] **è¾¹ç•Œæ¸…æ™°**ï¼šä¸ä¾èµ–ä½“ç§¯ Î± ç´¯åŠ å’Œ glow ä¹Ÿæœ‰æ¸…æ™°è½®å»“ï¼Œé›¶é¢ç¨³å®š
- [ ] **ç£¨ç ‚ç¨³å®š**ï¼šå™ªå£°é¢—ç²’éšè§†çº¿ç¨³å®šï¼Œä¸éšæ·±åº¦å±‚ç§¯æˆ–æ‹‰ä¸ï¼ˆå…³é”®ï¼ï¼‰
- [ ] **èåˆè‡ªç„¶**ï¼šä¸¤çƒåˆ†ç¦»â†’æ­æ¡¥â†’èåˆå¹³æ»‘è¿‡æ¸¡ï¼Œæ— "èƒ–è¾¹é›¾åŒ–"
- [ ] **æ³•çº¿å¹³æ»‘**ï¼šæ— é»‘æ´ã€è·³å˜æˆ–é—ªçƒ

### æ€§èƒ½æ ‡å‡†
- [ ] **å¸§æ—¶ < 16.7ms** @ 1080pï¼Œ6-12 ä¸ªçƒï¼ˆ60fpsï¼‰
- [ ] **å¹³å‡æ­¥æ•° < 64**ï¼ˆç†æƒ³ < 32ï¼‰
- [ ] **Miss ç‡ < 5%**ï¼ˆè¡¨é¢å®Œæ•´æ€§ï¼‰
- [ ] **å‘½ä¸­ç‡ > 99%**ï¼ˆMAX_STEPS è¶³å¤Ÿï¼‰

### é›†æˆæ ‡å‡†
- [ ] **ChatUI è”åŠ¨æ­£å¸¸**ï¼šfork/merge/combine äº‹ä»¶è§¦å‘æ— è¯¯
- [ ] **èƒŒæ™¯é€è¿‡**ï¼šè¾¹ç¼˜åŠé€æ˜ï¼ŒShaderPark èƒŒæ™¯å¯è§
- [ ] **UI å‚æ•°å¯æ§**ï¼šblendKã€HIT_EPSã€NORMAL_EPSã€noiseScale å››ä¸ªæ—‹é’®ç‹¬ç«‹è°ƒæ§

### å¯è°ƒæ€§æ ‡å‡†
- [ ] å¯è°ƒå‡º**æ¸…è¾¹/æŸ”è¾¹**ä¸¤ç§æ¡£ï¼ˆé€šè¿‡ blendKï¼‰
- [ ] å¯è°ƒå‡º**ç»†ç ‚/ç²—ç ‚**ä¸¤ç§æ¡£ï¼ˆé€šè¿‡ grainPow å’Œ noiseScaleï¼‰
- [ ] å¯å¿«é€Ÿåˆ‡æ¢ Phase 5/6 å¯¹æ¯”ï¼ˆUSE_SDF_METHOD å¼€å…³ï¼‰
- [ ] å¯åˆ‡æ¢å¤šé¡¹å¼/æŒ‡æ•° smooth-unionï¼ˆSMOOTH_UNION_TYPE å¼€å…³ï¼‰

---

## ğŸ“‹ å®æ–½æ­¥éª¤

### Step 0: å‡†å¤‡å·¥ä½œï¼ˆ10 åˆ†é’Ÿï¼‰

- [ ] **å¤‡ä»½å½“å‰ä»£ç **
  ```bash
  git add .
  git commit -m "Phase 5: volume rendering baseline (before Phase 6)"
  ```

- [ ] **åˆ›å»ºå®éªŒåˆ†æ”¯**ï¼ˆå¯é€‰ï¼‰
  ```bash
  git checkout -b feature/phase6-sdf-smooth-union
  ```

- [ ] **ç¡®è®¤å‚è€ƒæ–‡æ¡£å·²è¯»**
  - [ ] `RAYMARCHING_INTEGRATION_PLAN.md` Phase 6 ç« èŠ‚
  - [ ] `ref/Shader3/spCode.js` å‚è€ƒè´¨æ„Ÿå®ç°

#### 0.3 æ·»åŠ è°ƒè¯•å¼€å…³ âš ï¸ å…³é”®ï¼ˆä¾¿äºå›æ»šå¯¹æ¯”ï¼‰

åœ¨ Fragment Shader é¡¶éƒ¨ï¼ˆ`#ifdef` ä¹‹åï¼Œç¬¬ä¸€ä¸ª uniform ä¹‹å‰ï¼‰æ·»åŠ ï¼š

```glsl
// ============== è°ƒè¯•å¼€å…³ï¼ˆä¾¿äºå›æ»šå¯¹æ¯”ï¼‰ ==============
#define USE_SDF_METHOD 1        // 0=ä½“ç§¯æ¸²æŸ“(Phase 5), 1=SDFè¡¨é¢(Phase 6)
#define SMOOTH_UNION_TYPE 0     // 0=å¤šé¡¹å¼soft-min, 1=æŒ‡æ•°soft-min
#define NOISE_SPACE 0           // 0=view-space, 1=screen-space
#define DEBUG_PERF 0            // 1=è¾“å‡ºæ€§èƒ½ç»Ÿè®¡ï¼ˆæ­¥æ•°/missç‡ï¼‰

// ============== å¸¸é‡é…ç½® ==============
const float HIT_EPS = 1e-4;      // å‘½ä¸­åˆ¤å®šé˜ˆå€¼
const float NORMAL_EPS = 4e-4;   // æ³•çº¿å·®åˆ†æ­¥é•¿ï¼ˆ2-4å€HIT_EPSï¼‰âš ï¸ å…³é”®ï¼
const float MIN_STEP = 1e-3;     // æ­¥è¿›ä¸‹é™ï¼ˆé˜²èœ—ç‰›èµ°ï¼‰
const float MAX_STEP = 0.5;      // æ­¥è¿›ä¸Šé™ï¼ˆé˜²è¿‡æ­¥ï¼‰
```

**éªŒè¯ç‚¹**ï¼š
- [ ] ç¼–è¯‘é€šè¿‡
- [ ] å¯ä»¥é€šè¿‡ä¿®æ”¹ `USE_SDF_METHOD` å¿«é€Ÿåˆ‡æ¢ Phase 5/6

**ä¸ºä»€ä¹ˆéœ€è¦è¿™äº›å¼€å…³**ï¼š
- `USE_SDF_METHOD`ï¼šå‡ºé—®é¢˜æ—¶å¯ç«‹åˆ»å›é€€åˆ° Phase 5 å¯¹æ¯”
- `SMOOTH_UNION_TYPE`ï¼šå¤šé¡¹å¼ vs æŒ‡æ•°ï¼Œä¸åŒåœºæ™¯æ•ˆæœä¸åŒ
- `NOISE_SPACE`ï¼šéªŒè¯å™ªå£°ç»‘å®šçš„ç©ºé—´åŸŸæ˜¯å¦æ­£ç¡®
- **ä¸¤ä¸ª epsilon åˆ†å¼€**ï¼šé¿å…æ³•çº¿æŠ–åŠ¨ï¼ˆå¸¸è§é”™è¯¯ï¼‰
- **æ­¥è¿›æŠ¤æ **ï¼šé˜²æ­¢æç«¯æƒ…å†µï¼ˆæ å°„è§’/è–„å£³ï¼‰

---

### Step 1: æ›¿æ¢åœºå‡½æ•°ï¼ˆ30 åˆ†é’Ÿï¼‰

#### 1.1 æ·»åŠ  SDF è¾…åŠ©å‡½æ•°

åœ¨ `MetaCanvas.tsx` çš„ Fragment Shader ä¸­ï¼Œ**åœ¨ `field()` å‡½æ•°ä¹‹å‰**æ·»åŠ ï¼š

```glsl
// ============== SDF åŸºå…ƒ ==============

// å•ä¸ªçƒä½“çš„ SDFï¼ˆæœ‰ç¬¦å·è·ç¦»åœºï¼‰
float sdSphere(vec3 p, vec3 center, float radius) {
  return length(p - center) - radius;
}

// SDF å¹³æ»‘æœ€å°å€¼ï¼ˆäº§ç”Ÿèåˆæ•ˆæœï¼‰
float smin(float a, float b, float k) {
  #if SMOOTH_UNION_TYPE == 0
    // å¤šé¡¹å¼ soft-minï¼ˆæ›´ç¨³å®šï¼Œæ¨èï¼‰
    float h = max(k - abs(a - b), 0.0) / k;
    return min(a, b) - h * h * k * 0.25;
  #else
    // æŒ‡æ•° soft-minï¼ˆæ›´å¹³æ»‘ï¼Œä½†å°åŠå¾„æ—¶æ˜“è¿‡å¹³ï¼‰
    float res = exp(-k * a) + exp(-k * b);
    return -log(res) / k;
  #endif
}

// å¤šçƒ SDF åœºï¼ˆsmooth union èåˆï¼‰
float sdfMetaballs(vec3 p) {
  float d = 1e10;  // åˆå§‹åŒ–ä¸ºå¾ˆå¤§çš„è·ç¦»

  for (int i = 0; i < MAX_SOURCES; ++i) {
    if (i >= u_source_count) break;

    float di = sdSphere(p, u_source_pos[i], u_source_rad[i]);

    // å¹³æ»‘èåˆï¼ˆk å‚æ•°æ§åˆ¶èåˆèŒƒå›´ï¼‰
    d = smin(d, di, u_blend_k);
  }

  return d;  // è¿”å›å¸¦ç¬¦å·è·ç¦»
}
```

**éªŒè¯ç‚¹**ï¼š
- [ ] Shader ç¼–è¯‘æ— é”™è¯¯
- [ ] Console æ—  WebGL é”™è¯¯

#### 1.2 æ·»åŠ æ–°çš„ Uniform

åœ¨ Fragment Shader çš„ uniform å£°æ˜åŒºåŸŸï¼ˆçº¦ 125 è¡Œï¼‰ï¼š

```glsl
// ====== åˆ é™¤ä»¥ä¸‹æ—§ uniform ======
// uniform float u_threshold_t;   // âŒ åˆ é™¤
// uniform float u_kernel_eps;    // âŒ åˆ é™¤
// uniform float u_kernel_pow;    // âŒ åˆ é™¤

// ====== æ·»åŠ æ–° uniform ======
uniform float u_blend_k;  // âœ… æ–°å¢ï¼šSmooth union èåˆå®½åº¦ï¼ˆ0.2-0.8ï¼‰
```

#### 1.3 æ›´æ–° TypeScript Uniform è®¾ç½®

åœ¨ `render()` å‡½æ•°ä¸­ï¼ˆçº¦ 600 è¡Œï¼‰ï¼š

```typescript
// ====== åˆ é™¤æ—§ uniform è®¾ç½® ======
// const thresholdTLoc = gl.getUniformLocation(program, 'u_threshold_t');  // âŒ åˆ é™¤
// const kernelEpsLoc = gl.getUniformLocation(program, 'u_kernel_eps');    // âŒ åˆ é™¤
// const kernelPowLoc = gl.getUniformLocation(program, 'u_kernel_pow');    // âŒ åˆ é™¤

// ====== æ·»åŠ æ–° uniform è·å– ======
const blendKLoc = gl.getUniformLocation(program, 'u_blend_k');  // âœ… æ–°å¢

// ====== è®¾ç½®æ–° uniform å€¼ ======
if (blendKLoc) gl.uniform1f(blendKLoc, 0.5);  // âœ… åˆå§‹å€¼ 0.5
```

#### 1.4 åˆ é™¤ raymarchParams ä¸­çš„æ—§å‚æ•°

åœ¨ `raymarchParams` é…ç½®å¯¹è±¡ä¸­ï¼ˆçº¦ 479 è¡Œï¼‰ï¼š

```typescript
const raymarchParams = {
  // âŒ åˆ é™¤ä»¥ä¸‹ä¸‰ä¸ª
  // thresholdT: 1.0,
  // kernelEps: 1e-3,
  // kernelPow: 2.0,

  // âœ… æ·»åŠ æ–°å‚æ•°
  blendK: 0.5,        // Smooth union èåˆå®½åº¦

  // ä¿æŒå…¶ä»–å‚æ•°ä¸å˜
  rCut: 2.5,
  stepFar: 0.15,
  stepNear: 0.015,
  fGate: 0.3,
  epsHit: 1e-4,       // âœ… å¯ä»¥æ”¹æ›´å°ï¼ˆSDF æ›´ç²¾ç¡®ï¼‰
  maxSteps: 256,
  // ...
};
```

**éªŒè¯ç‚¹**ï¼š
- [ ] TypeScript ç¼–è¯‘æ— é”™è¯¯
- [ ] æµè§ˆå™¨ Console æ—  uniform è­¦å‘Š

---

### Step 2: å®ç° Sphere Tracingï¼ˆ30 åˆ†é’Ÿï¼‰

#### 2.1 æ›¿æ¢ main() ä¸­çš„ä½“ç§¯æ¸²æŸ“ä»£ç 

**æ‰¾åˆ° `main()` å‡½æ•°ä¸­çš„ä½“ç§¯æ¸²æŸ“å¾ªç¯**ï¼ˆçº¦ 370-395 è¡Œï¼‰ï¼Œ**å®Œå…¨æ›¿æ¢**ä¸ºï¼š

```glsl
void main() {
  vec2 fragCoord = gl_FragCoord.xy;

  // 1) ç›¸æœºå°„çº¿
  vec3 ro, rd;
  makeRay(fragCoord, ro, rd);

  // 2) AABB è£å‰ª
  float tNear, tFar;
  float hitBox = sdBox(ro, rd, u_bounds_min, u_bounds_max, tNear, tFar);
  if (hitBox < 0.5) {
    gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);  // æœªå‘½ä¸­åŒ…å›´ç›’ï¼Œé€æ˜
    return;
  }

  // 3) Sphere Tracing æ­¥è¿›
  float t = max(tNear, 0.0);
  bool hit = false;
  float prevD = 1e10;  // âœ… è®°å½•ä¸Šä¸€æ­¥è·ç¦»ï¼ˆç”¨äºæ å°„è§’åˆ¤å®šï¼‰

  for (int i = 0; i < u_max_steps; ++i) {
    if (t > tFar) break;

    vec3 p = ro + rd * t;
    float d = sdfMetaballs(p);  // âœ… ä½¿ç”¨ SDF è·ç¦»åœº

    // âœ… æ”¹è¿›çš„å‘½ä¸­åˆ¤å®šï¼ˆç»“åˆè·ç¦»å‡å°è¶‹åŠ¿ï¼‰
    if (d < HIT_EPS || (d < prevD && d < HIT_EPS * 2.0)) {
      // å‘½ä¸­ï¼å¯é€‰ï¼šäºŒåˆ†ç²¾åŒ–ï¼ˆå…ˆè·³è¿‡ï¼Œåç»­ä¼˜åŒ–ï¼‰
      hit = true;
      break;
    }

    // âœ… æ­¥è¿›æŠ¤æ ï¼ˆé˜²æ­¢æç«¯æƒ…å†µï¼‰
    float step = clamp(d, MIN_STEP, MAX_STEP);
    t += step;
    prevD = d;
  }

  if (!hit) {
    gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);  // æœªå‘½ä¸­ï¼Œé€æ˜
    return;
  }

  // 4) å‘½ä¸­ç‚¹ç€è‰²ï¼ˆä¸´æ—¶ï¼šçº¯è‰²è°ƒè¯•ï¼‰
  vec3 p = ro + rd * t;
  gl_FragColor = vec4(1.0, 0.0, 1.0, 1.0);  // æ´‹çº¢è‰²æ ‡è®°å‘½ä¸­
}
```

**éªŒè¯ç‚¹**ï¼š
- [ ] ç¼–è¯‘é€šè¿‡
- [ ] **çœ‹åˆ°æ´‹çº¢è‰²çš„çƒä½“**ï¼ˆå‘½ä¸­å¯è§†åŒ–ï¼‰
- [ ] çƒä½“è¾¹ç•Œæ¸…æ™°ï¼Œæ— ç‚¹çŠ¶ç¯å¸¦
- [ ] ä¸¤ä¸ªçƒé è¿‘æ—¶æœ‰èåˆæ•ˆæœ

**å¦‚æœçœ‹ä¸åˆ°çƒ**ï¼š
1. æ£€æŸ¥ `u_blend_k` æ˜¯å¦æ­£ç¡®ä¼ é€’ï¼ˆConsole è¾“å‡º uniform å€¼ï¼‰
2. ä¸´æ—¶å¢å¤§ `u_eps_hit` åˆ° `1e-3` æˆ– `1e-2`
3. æ£€æŸ¥ `u_source_count` å’Œ `u_source_pos` æ•°ç»„

---

### Step 3: æ·»åŠ æ³•çº¿å’Œå…‰ç…§ï¼ˆ30 åˆ†é’Ÿï¼‰

#### 3.1 ä¸¤ä¸ª epsilon åˆ†å¼€ç®¡ç† âš ï¸ æ˜“é”™é¡¹ï¼

**æ˜“é”™ç‚¹**ï¼šå‘½ä¸­é˜ˆå€¼ï¼ˆHIT_EPSï¼‰å’Œæ³•çº¿å·®åˆ†æ­¥é•¿ï¼ˆNORMAL_EPSï¼‰**å¿…é¡»åˆ†å¼€**ã€‚

```glsl
// âŒ é”™è¯¯ï¼šå…±ç”¨ä¸€ä¸ª epsilon
const float EPS = 1e-4;
if (d < EPS) { /* å‘½ä¸­ */ }
vec3 n = sdfNormal(p, EPS);  // æ³•çº¿ä¹Ÿç”¨åŒä¸€ä¸ª â†’ æŠ–åŠ¨ï¼

// âœ… æ­£ç¡®ï¼šåˆ†å¼€ç®¡ç†ï¼ˆå·²åœ¨ Step 0.3 å®šä¹‰ï¼‰
const float HIT_EPS = 1e-4;      // å‘½ä¸­åˆ¤å®š
const float NORMAL_EPS = 4e-4;   // æ³•çº¿å·®åˆ†ï¼ˆ2-4å€HIT_EPSï¼‰

if (d < HIT_EPS) { /* å‘½ä¸­ */ }
vec3 n = sdfNormal(p, NORMAL_EPS);  // âœ… ä½¿ç”¨ä¸“é—¨çš„æ³•çº¿epsilon
```

**åŸå› **ï¼š
- NORMAL_EPS å¤ªå° â†’ æ•°å€¼è¯¯å·® â†’ æ³•çº¿æŠ–åŠ¨/é»‘æ´
- NORMAL_EPS å¤ªå¤§ â†’ æ³•çº¿ä¸å‡†ç¡®
- **æ¨èå…³ç³»**ï¼š`NORMAL_EPS = 2~4 * HIT_EPS`

#### 3.2 æ›´æ–° sdfNormal å‡½æ•°

**æ›¿æ¢åŸæœ‰çš„ `normalTetra()` æˆ– `normalCentral()`**ï¼Œæ”¹ä¸º SDF æ¢¯åº¦æ³•çº¿ï¼š

```glsl
// SDF æ¢¯åº¦æ³•çº¿ï¼ˆä¸­å¿ƒå·®åˆ†ï¼Œepsilon ä½œä¸ºå‚æ•°ï¼‰
vec3 sdfNormal(vec3 p, float e) {  // âœ… epsilon ä½œä¸ºå‚æ•°
  vec3 n = vec3(
    sdfMetaballs(vec3(p.x + e, p.y, p.z)) - sdfMetaballs(vec3(p.x - e, p.y, p.z)),
    sdfMetaballs(vec3(p.x, p.y + e, p.z)) - sdfMetaballs(vec3(p.x, p.y - e, p.z)),
    sdfMetaballs(vec3(p.x, p.y, p.z + e)) - sdfMetaballs(vec3(p.x, p.y, p.z - e))
  );
  return normalize(n);
}
```

#### 3.3 æ·»åŠ  Lambert å…‰ç…§ç€è‰²

**æ›¿æ¢ `main()` ä¸­çš„æ´‹çº¢è‰²è°ƒè¯•ä»£ç **ï¼ˆStep 2.1 çš„æœ€åéƒ¨åˆ†ï¼‰ï¼š

```glsl
// 4) å‘½ä¸­ç‚¹ç€è‰²
vec3 p = ro + rd * t;
vec3 n = sdfNormal(p, NORMAL_EPS);  // âœ… ä½¿ç”¨ NORMAL_EPS

// Lambert å…‰ç…§
vec3 lightDir = normalize(u_light_dir);
float ndotl = max(dot(n, lightDir), 0.0);
vec3 albedo = u_albedo;  // åŸºç¡€åå°„ç‡ï¼ˆç™½è‰²ï¼‰
vec3 col = albedo * (u_ambient + (1.0 - u_ambient) * ndotl);

gl_FragColor = vec4(col, 1.0);  // âœ… åŸºç¡€å…‰ç…§ï¼Œä¸é€æ˜
```

**éªŒè¯ç‚¹**ï¼š
- [ ] **çœ‹åˆ°æœ‰æ˜æš—å˜åŒ–çš„ç™½è‰²çƒä½“**
- [ ] å…‰ç…§æ¥è‡ª `lightDir` æ–¹å‘ï¼ˆå¯è°ƒæ•´è§‚å¯Ÿï¼‰
- [ ] æ³•çº¿å¹³æ»‘ï¼Œæ— é»‘æ´æˆ–è·³å˜
- [ ] è¾¹ç•Œæ¸…æ™°ï¼Œæœ‰ä½“ç§¯æ„Ÿ

**å¦‚æœæ³•çº¿å¼‚å¸¸**ï¼š
1. æ£€æŸ¥ `sdfNormal()` çš„ epsilonï¼ˆè¯• `1e-3` æˆ– `5e-4`ï¼‰
2. è¾“å‡ºæ³•çº¿é¢œè‰²è°ƒè¯•ï¼š`gl_FragColor = vec4(n * 0.5 + 0.5, 1.0);`

---

### Step 4: æ·»åŠ ç£¨ç ‚è´¨æ„Ÿï¼ˆ1 å°æ—¶ï¼Œå«è°ƒä¼˜ï¼‰âš ï¸ å…³é”®æ­¥éª¤

#### 4.1 ç»‘å®š view-space å™ªå£°

**åœ¨ `main()` çš„å…‰ç…§è®¡ç®—ä¹‹å**ï¼š

```glsl
// 5) ç£¨ç ‚é¢—ç²’è´¨æ„Ÿï¼ˆå…³é”®ï¼ï¼‰
// âœ… å™ªå£°ç»‘å®šåœ¨**è§†çº¿æ–¹å‘**ï¼ˆview-spaceï¼‰ï¼Œä¸æ˜¯ world-space
#if NOISE_SPACE == 0
  // View-space å™ªå£°ï¼ˆæ¨èï¼Œç£¨ç ‚æ„Ÿï¼‰
  vec3 s = rd;  // â† è§†çº¿æ–¹å‘ï¼ˆç­‰åŒäº ShaderPark çš„ getRayDirection()ï¼‰
#else
  // Screen-space å™ªå£°ï¼ˆå¤‡é€‰ï¼Œé¢—ç²’æ›´ç¨³å®šä½†ç¼ºä¹3Dæ„Ÿï¼‰
  vec3 s = vec3(gl_FragCoord.xy / u_resolution, 0.0);
#endif

float noiseVal = snoise(s * 5.0 + vec3(0, 0, u_time * 0.1));  // âœ… æ—¶é—´åŠ¨ç”»
noiseVal = noiseVal * 0.5 + 0.5;  // æ˜ å°„åˆ° [0,1]

// âœ… é«˜ä¼½é©¬é¢—ç²’åŒ–ï¼ˆå‚è€ƒä»£ç ç”¨ pow(n, 8)ï¼‰
float grain = pow(noiseVal, 8.0);

// âœ… è°ƒåˆ¶è¡¨é¢é¢œè‰²ï¼ˆä¸æ˜¯ alphaï¼ï¼‰
col *= mix(0.8, 1.2, grain);  // é¢œè‰²è°ƒåˆ¶èŒƒå›´ï¼š80% - 120%
```

**éªŒè¯ç‚¹**ï¼š
- [ ] **çœ‹åˆ°ç£¨ç ‚é¢—ç²’æ„Ÿ**ï¼ˆè¡¨é¢æœ‰ç»†å¾®æ˜æš—å˜åŒ–ï¼‰
- [ ] é¢—ç²’éš**è§†çº¿ç§»åŠ¨è€Œå˜åŒ–**ï¼Œä½†åœ¨åŒä¸€è§†è§’ä¸‹ç¨³å®š
- [ ] **æ²¡æœ‰äº‘é›¾æ„Ÿ**ï¼ˆå¦‚æœæœ‰äº‘é›¾ï¼Œè¯´æ˜ç»‘å®šé”™äº†ç©ºé—´åŸŸï¼‰

**è°ƒä¼˜å‚æ•°**ï¼š
- `s * 5.0`ï¼šå™ªå£°é¢‘ç‡ï¼ˆ5.0 = ç»†é¢—ç²’ï¼Œ2.0 = ç²—é¢—ç²’ï¼‰
- `pow(noiseVal, 8.0)`ï¼šé¢—ç²’åŒ–ç¨‹åº¦ï¼ˆ8.0 è¾ƒå¼ºï¼Œ6.0 è¾ƒå¼±ï¼Œ10.0 æå¼ºï¼‰
- `mix(0.8, 1.2, grain)`ï¼šé¢œè‰²è°ƒåˆ¶èŒƒå›´ï¼ˆå¯è°ƒä¸º 0.9-1.1 æ›´æŸ”å’Œï¼‰

**å¦‚æœè¿˜æ˜¯äº‘é›¾æ„Ÿ**ï¼š
1. âŒ æ£€æŸ¥æ˜¯å¦é”™è¯¯å†™æˆ `snoise(p * 5.0)`ï¼ˆworld-spaceï¼‰
2. âœ… å¿…é¡»æ˜¯ `snoise(rd * 5.0)` æˆ– `snoise(s * 5.0)`ï¼ˆview-spaceï¼‰

#### 4.2 å‡çº§åˆ° FBMï¼ˆå¯é€‰ï¼Œæå‡è´¨æ„Ÿå±‚æ¬¡ï¼‰

å¦‚æœå•å±‚å™ªå£°ä¸å¤Ÿç»†è…»ï¼Œå¯å‡çº§ä¸ºå¤šå±‚å åŠ ï¼ˆå‚è€ƒä»£ç ç”¨äº† `fbm()`ï¼‰ï¼š

```glsl
// FBMï¼ˆFractional Brownian Motionï¼‰
float fbm3D(vec3 p) {
  float value = 0.0;
  float amplitude = 0.5;
  float frequency = 1.0;

  for (int i = 0; i < 3; ++i) {  // 3 å±‚å åŠ 
    value += amplitude * snoise(p * frequency);
    frequency *= 2.0;
    amplitude *= 0.5;
  }

  return value;
}

// ä½¿ç”¨ FBM æ›¿ä»£å•å±‚ snoise
float noiseVal = fbm3D(s * 5.0 + vec3(0, 0, u_time * 0.1));
```

**éªŒè¯ç‚¹**ï¼š
- [ ] é¢—ç²’å±‚æ¬¡æ›´ä¸°å¯Œ
- [ ] ä»ä¿æŒ view-space ç‰¹æ€§

---

### Step 5: æ·»åŠ è¾¹ç¼˜é€æ˜åº¦ï¼ˆ30 åˆ†é’Ÿï¼‰

#### 5.1 Fresnel è¾¹ç¼˜é€æ˜

**åœ¨ `main()` æœ€åè¾“å‡ºå‰**ï¼š

```glsl
// 6) è¾¹ç¼˜é€æ˜åº¦ï¼ˆFresnel æ•ˆæœï¼‰
float fresnel = pow(1.0 - abs(dot(n, -rd)), 2.0);  // âœ… Fresnel å¹‚æ¬¡ 2.0
float alpha = mix(0.9, 0.3, fresnel);  // ä¸­å¿ƒ 90% ä¸é€æ˜ï¼Œè¾¹ç¼˜ 30%

// âœ… æœ€ç»ˆè¾“å‡ºï¼ˆé¢„ä¹˜ Alphaï¼‰
gl_FragColor = vec4(col * alpha, alpha);
```

**éªŒè¯ç‚¹**ï¼š
- [ ] çƒä½“ä¸­å¿ƒåŸºæœ¬ä¸é€æ˜
- [ ] è¾¹ç¼˜åŠé€æ˜ï¼ŒShaderPark èƒŒæ™¯å¯è§
- [ ] è¿‡æ¸¡å¹³æ»‘ï¼Œæ— çªå˜

**è°ƒä¼˜å‚æ•°**ï¼š
- `pow(..., 2.0)`ï¼šFresnel å¹‚æ¬¡ï¼ˆ1.5 = æ›´é€ï¼Œ3.0 = æ›´ä¸é€ï¼‰
- `mix(0.9, 0.3, ...)`ï¼šä¸é€æ˜åº¦èŒƒå›´ï¼ˆå¯è°ƒä¸º 0.95-0.2ï¼‰

**å¦‚æœèƒŒæ™¯è¢«å®Œå…¨é®æŒ¡**ï¼š
1. é™ä½ä¸­å¿ƒä¸é€æ˜åº¦ï¼š`mix(0.8, 0.2, fresnel)`
2. å¢åŠ  Fresnel å¹‚æ¬¡ï¼š`pow(..., 1.5)`

---

### Step 6: UI å‚æ•°æ§åˆ¶ï¼ˆ30 åˆ†é’Ÿï¼‰

#### 6.1 æ·»åŠ  blendK æ»‘å—

åœ¨ `MetaCanvas.tsx` çš„æ§åˆ¶é¢æ¿ä¸­ï¼ˆçº¦ 1343 è¡Œï¼‰ï¼š

```tsx
// æ·»åŠ  blendK state
const [blendK, setBlendK] = useState(0.5);

// åœ¨ useEffect ä¸­æ›´æ–° uniformï¼ˆçº¦ 868 è¡Œï¼‰
useEffect(() => {
  if (runtimeRef.current) {
    // ... ç°æœ‰ä»£ç 
    runtimeRef.current.setInputs({
      // ... ç°æœ‰å‚æ•°
      blendK  // âœ… æ–°å¢
    });
  }
}, [k, r, d, sigma, gain, time, sources, tree, blendK]);  // âœ… æ·»åŠ ä¾èµ–

// åœ¨æ§åˆ¶é¢æ¿æ·»åŠ æ»‘å—ï¼ˆ1343 è¡Œä¹‹åï¼‰
<div style={{ marginBottom: '8px', fontSize: '12px', display: 'flex', alignItems: 'center', gap: '8px' }}>
  <span style={{ width: '30px' }}>èåˆ</span>
  <input
    type="range"
    min={0.2}
    max={0.8}
    step={0.05}
    value={blendK}
    onChange={e => setBlendK(parseFloat(e.target.value))}
    style={{ flex: 1 }}
  />
  <span style={{ width: '30px', textAlign: 'right' }}>{blendK.toFixed(2)}</span>
</div>
```

#### 6.2 ä¿®æ”¹ `createMinimalRendererFromString` æ¥æ”¶ blendK

åœ¨ `SPInputs` ç±»å‹ä¸­ï¼ˆçº¦ 58 è¡Œï¼‰ï¼š

```typescript
type SPInputs = {
  // ... ç°æœ‰å‚æ•°
  blendK?: number;  // âœ… æ–°å¢
};
```

åœ¨ `render()` å‡½æ•°ä¸­è®¾ç½® uniformï¼ˆçº¦ 640 è¡Œï¼‰ï¼š

```typescript
// âŒ åˆ é™¤æ—§çš„è®¾ç½®
// if (thresholdTLoc) gl.uniform1f(thresholdTLoc, raymarchParams.thresholdT);

// âœ… æ·»åŠ æ–°çš„è®¾ç½®
const blendKLoc = gl.getUniformLocation(program, 'u_blend_k');
if (blendKLoc) gl.uniform1f(blendKLoc, params.blendK ?? 0.5);
```

**éªŒè¯ç‚¹**ï¼š
- [ ] æ»‘å—è°ƒæ•´ blendK æ—¶ï¼Œèåˆæ•ˆæœå®æ—¶å˜åŒ–
- [ ] 0.2 = å‡ ä¹ä¸èåˆï¼ˆåˆ†ç¦»æ¸…æ™°ï¼‰
- [ ] 0.8 = æ˜æ˜¾èåˆï¼ˆæ­æ¡¥å®½é˜”ï¼‰

---

### Step 7: æ€§èƒ½ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰

#### 7.1 é™ä½æ­¥æ•°ï¼ˆå¦‚æœ FPS < 30ï¼‰

```typescript
const raymarchParams = {
  maxSteps: 128,  // ä» 256 é™åˆ° 128ï¼ˆæˆ– 64ï¼‰
  // ...
};
```

#### 7.2 åŠåˆ†è¾¨ç‡æ¸²æŸ“ï¼ˆé«˜çº§ï¼‰

```typescript
// åœ¨ updateCanvasSize() ä¸­
const renderScale = 0.75;  // 75% åˆ†è¾¨ç‡
canvas.width = Math.floor(windowWidth * renderScale);
canvas.height = Math.floor(windowHeight * renderScale);
```

**æƒè¡¡**ï¼š
- FPS æå‡ 2-4x
- ç»†èŠ‚ç•¥æœ‰æŸå¤±ï¼ˆä½†ç£¨ç ‚è´¨æ„Ÿä¼šæ©ç›–ï¼‰

---

## ğŸ› æ•…éšœæ’é™¤

### é—®é¢˜ 1: å…¨é»‘å±å¹•

**æ’æŸ¥**ï¼š
1. æ£€æŸ¥ Shader ç¼–è¯‘ï¼š
   ```typescript
   const compiled = gl.getShaderParameter(shader, gl.COMPILE_STATUS);
   if (!compiled) console.error(gl.getShaderInfoLog(shader));
   ```
2. è¾“å‡ºå›ºå®šé¢œè‰²æµ‹è¯•ï¼š
   ```glsl
   gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0); return;
   ```
3. æ£€æŸ¥ AABB åŒ…å«å°„çº¿

### é—®é¢˜ 2: åœºå¼ºå¯è§ä½†ä¸å‘½ä¸­

**è§£å†³**ï¼š
- æ”¾å®½å‘½ä¸­é˜ˆå€¼ï¼š`epsHit = 1e-2`
- å¢åŠ æ­¥æ•°ï¼š`maxSteps = 256`
- æ£€æŸ¥ `u_blend_k` æ˜¯å¦ä¼ é€’

### é—®é¢˜ 3: æ³•çº¿å¼‚å¸¸ï¼ˆé»‘æ´/é—ªçƒï¼‰

**è§£å†³**ï¼š
- è°ƒæ•´ epsilonï¼š`e = 5e-4` æˆ– `1e-3`
- è¾“å‡ºæ³•çº¿é¢œè‰²è°ƒè¯•ï¼š
  ```glsl
  gl_FragColor = vec4(n * 0.5 + 0.5, 1.0);
  ```

### é—®é¢˜ 4: è¿˜æ˜¯äº‘é›¾æ„Ÿï¼ˆæœ€å…³é”®ï¼ï¼‰

**æ£€æŸ¥æ¸…å•**ï¼š
- [ ] âŒ é”™è¯¯ï¼š`snoise(p * 5.0)`ï¼ˆworld-spaceï¼‰
- [ ] âœ… æ­£ç¡®ï¼š`snoise(rd * 5.0)`ï¼ˆview-spaceï¼‰
- [ ] âŒ é”™è¯¯ï¼šè°ƒåˆ¶ alpha/density
- [ ] âœ… æ­£ç¡®ï¼šè°ƒåˆ¶ color

### é—®é¢˜ 5: æ€§èƒ½å¾ˆå·® (<15 FPS)

**å¿«é€Ÿä¼˜åŒ–**ï¼š
- é™ä½æ­¥æ•°ï¼š`maxSteps = 64`
- é™ä½åˆ†è¾¨ç‡ï¼š`renderScale = 0.5`
- å‡å°‘æºæ•°é‡æµ‹è¯•ï¼ˆä¸´æ—¶ï¼‰

### é—®é¢˜ 6: è–„å£³/æ å°„è§’å¤„æœ‰æ–­è£‚ âš ï¸ æ–°å¢

**åŸå› **ï¼šæ­¥é•¿è¿‡å¤§ï¼Œè·¨è¿‡è–„å£³

**è§£å†³**ï¼š
1. æ·»åŠ æ­¥è¿›æŠ¤æ ï¼ˆå·²åœ¨ Step 2 ä¸­ï¼‰ï¼š
   ```glsl
   float step = clamp(d, MIN_STEP, MAX_STEP);
   t += step;
   ```

2. æ”¹è¿›å‘½ä¸­åˆ¤å®šï¼ˆç»“åˆè·ç¦»å‡å°è¶‹åŠ¿ï¼Œå·²åœ¨ Step 2 ä¸­ï¼‰ï¼š
   ```glsl
   if (d < HIT_EPS || (d < prevD && d < HIT_EPS * 2.0))
   ```

3. å¢åŠ ç²¾åŒ–æ­¥æ•°ï¼ˆå¯é€‰ï¼Œåç»­ä¼˜åŒ–ï¼‰ï¼š
   ```glsl
   // å‘½ä¸­åè¿›è¡ŒäºŒåˆ†ç²¾åŒ–
   for (int j = 0; j < 5; ++j) {
     float tm = t - d * 0.5;
     vec3 pm = ro + rd * tm;
     float dm = sdfMetaballs(pm);
     if (abs(dm) < abs(d)) { t = tm; d = dm; }
   }
   ```

### é—®é¢˜ 7: æ³•çº¿æŠ–åŠ¨/é»‘æ´ âš ï¸ æ–°å¢

**åŸå› **ï¼šNORMAL_EPS å¤ªå°æˆ–ä¸ HIT_EPS å…±ç”¨

**è§£å†³**ï¼š
- åˆ†å¼€ç®¡ç†ä¸¤ä¸ª epsilonï¼ˆå·²åœ¨ Step 0.3 å’Œ Step 3.1ï¼‰
- NORMAL_EPS = 2~4 * HIT_EPS
- å…¸å‹å€¼ï¼šHIT_EPS=1e-4, NORMAL_EPS=4e-4

**éªŒè¯**ï¼šè¾“å‡ºæ³•çº¿é¢œè‰²è°ƒè¯•
```glsl
gl_FragColor = vec4(n * 0.5 + 0.5, 1.0);
```

### é—®é¢˜ 8: èåˆæ•ˆæœä¸è‡ªç„¶

**åŸå› **ï¼šblendK å‚æ•°ä¸åˆé€‚ï¼Œæˆ– smooth-union ç±»å‹ä¸åŒ¹é…åœºæ™¯

**è§£å†³**ï¼š
1. è°ƒæ•´ `blendK`ï¼š
   - 0.2 = å‡ ä¹ä¸èåˆï¼ˆåˆ†ç¦»æ¸…æ™°ï¼‰
   - 0.5 = å¹³è¡¡ï¼ˆæ¨èï¼‰
   - 0.8 = æ˜æ˜¾èåˆï¼ˆæ­æ¡¥å®½é˜”ï¼‰

2. åˆ‡æ¢ smooth-union ç±»å‹ï¼ˆé€šè¿‡ `SMOOTH_UNION_TYPE`ï¼‰ï¼š
   - 0 = å¤šé¡¹å¼ï¼ˆæ›´ç¨³å®šï¼Œæ¨èï¼‰
   - 1 = æŒ‡æ•°ï¼ˆæ›´å¹³æ»‘ï¼Œä½†å°åŠå¾„æ˜“è¿‡å¹³ï¼‰

---

## ğŸ“Š å‚æ•°é€ŸæŸ¥è¡¨

| å‚æ•° | åˆå§‹å€¼ | èŒƒå›´ | ä½œç”¨ | ä¼˜å…ˆçº§ |
|------|--------|------|------|--------|
| `HIT_EPS` | **1e-4** | 1e-5~1e-2 | å‘½ä¸­é˜ˆå€¼ | â­â­â­ |
| `NORMAL_EPS` | **4e-4** | 2e-4~8e-4 | æ³•çº¿å·®åˆ†æ­¥é•¿ï¼ˆ2-4å€HIT_EPSï¼‰| â­â­â­ |
| `MIN_STEP` | **1e-3** | 5e-4~2e-3 | æ­¥è¿›ä¸‹é™ï¼ˆé˜²èœ—ç‰›èµ°ï¼‰| â­â­ |
| `MAX_STEP` | **0.5** | 0.3~1.0 | æ­¥è¿›ä¸Šé™ï¼ˆé˜²è¿‡æ­¥ï¼‰| â­â­ |
| `uBlendK` | **0.5** | 0.2-0.8 | Smooth union èåˆå®½åº¦ | â­â­â­ |
| `grainPow` | **8.0** | 6.0-10.0 | å™ªå£°é¢—ç²’åŒ–ç¨‹åº¦ | â­â­â­ |
| `noiseScale` | **5.0** | 2.0-10.0 | å™ªå£°é¢‘ç‡ | â­â­ |
| `fresnelPow` | **2.0** | 1.5-3.0 | è¾¹ç¼˜é€æ˜åº¦ | â­ |
| `alpha range` | **0.9-0.3** | 0.95-0.2 | ä¸­å¿ƒ-è¾¹ç¼˜ä¸é€æ˜åº¦ | â­ |

---

## ğŸ“ˆ æ€§èƒ½ç›‘æ§ï¼ˆå¯é€‰ï¼Œå»ºè®®æ·»åŠ ï¼‰

åœ¨ Fragment Shader ä¸­æ·»åŠ æ€§èƒ½ç»Ÿè®¡ï¼š

```glsl
#if DEBUG_PERF
  // åœ¨ main() çš„æ­¥è¿›å¾ªç¯ä¸­
  int stepCount = 0;
  for (int i = 0; i < u_max_steps; ++i) {
    stepCount++;
    // ... æ­¥è¿›é€»è¾‘
  }

  // åœ¨ JavaScript ä¸­æ”¶é›†ç»Ÿè®¡
  // æ¯100å¸§è¾“å‡ºä¸€æ¬¡å¹³å‡æ­¥æ•°å’Œå‘½ä¸­ç‡
#endif
```

åœ¨ TypeScript ä¸­æ·»åŠ ç»Ÿè®¡æ”¶é›†ï¼š

```typescript
// åœ¨ç»„ä»¶ä¸­æ·»åŠ æ€§èƒ½è®¡æ•°å™¨
const perfStats = useRef({
  frameCount: 0,
  totalSteps: 0,
  missCount: 0
});

// åœ¨æ¸²æŸ“å¾ªç¯ä¸­ï¼ˆå¯é€‰ï¼‰
useEffect(() => {
  const interval = setInterval(() => {
    const stats = perfStats.current;
    if (stats.frameCount > 0) {
      const avgSteps = stats.totalSteps / stats.frameCount;
      const missRate = stats.missCount / stats.frameCount;
      console.log(`[Perf] Avg steps: ${avgSteps.toFixed(1)}, Miss rate: ${(missRate * 100).toFixed(1)}%`);

      // é‡ç½®è®¡æ•°å™¨
      stats.frameCount = 0;
      stats.totalSteps = 0;
      stats.missCount = 0;
    }
  }, 5000); // æ¯5ç§’è¾“å‡ºä¸€æ¬¡

  return () => clearInterval(interval);
}, []);
```

**ç›‘æ§æŒ‡æ ‡**ï¼š
- å¹³å‡æ­¥æ•°ï¼šåº”è¯¥ < 32ï¼ˆæœ€ä¼˜ï¼‰ï¼Œ< 64ï¼ˆå¯æ¥å—ï¼‰
- Miss ç‡ï¼šåº”è¯¥ < 5%ï¼ˆè¡¨é¢å®Œæ•´ï¼‰
- å¸§æ—¶ï¼š< 16.7msï¼ˆ60fpsï¼‰ï¼Œ< 33.3msï¼ˆ30fpså¯æ¥å—ï¼‰

---

## âœ… å®Œæˆæ¸…å•

### æ ¸å¿ƒåŠŸèƒ½
- [ ] SDF åœºå‡½æ•°æ›¿æ¢å®Œæˆ
- [ ] Sphere tracing æ­¥è¿›æ­£å¸¸
- [ ] æ³•çº¿è®¡ç®—ç¨³å®š
- [ ] Lambert å…‰ç…§æ­£å¸¸
- [ ] ç£¨ç ‚è´¨æ„Ÿï¼ˆview-space å™ªå£°ï¼‰
- [ ] è¾¹ç¼˜é€æ˜åº¦ï¼ˆFresnelï¼‰

### è´¨é‡éªŒæ”¶
- [ ] æ— ç‚¹çŠ¶ç¯å¸¦
- [ ] è¾¹ç•Œæ¸…æ™°
- [ ] ç£¨ç ‚é¢—ç²’ç¨³å®š
- [ ] èåˆè‡ªç„¶
- [ ] èƒŒæ™¯é€è¿‡

### æ€§èƒ½ä¸é›†æˆ
- [ ] FPS â‰¥ 30ï¼ˆ1080pï¼Œ10 ä¸ªçƒï¼‰
- [ ] ChatUI è”åŠ¨æ­£å¸¸ï¼ˆfork/merge/combineï¼‰
- [ ] UI å‚æ•°æ§åˆ¶æ­£å¸¸

### å¯é€‰ä¼˜åŒ–
- [ ] å‡çº§åˆ° FBM å™ªå£°
- [ ] æ·»åŠ ç²¾åŒ–æ­¥éª¤
- [ ] åŠåˆ†è¾¨ç‡æ¸²æŸ“
- [ ] ç©ºé—´åŠ é€Ÿç»“æ„

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

**ç«‹å³å¼€å§‹**ï¼š
1. âœ… é˜…è¯»æœ¬ TODO æ–‡æ¡£
2. â­ï¸ æ‰§è¡Œ Step 0ï¼ˆå¤‡ä»½ä»£ç ï¼‰
3. â­ï¸ æŒ‰é¡ºåºæ‰§è¡Œ Step 1-5
4. â­ï¸ æ¯ä¸ª Step å®ŒæˆåéªŒè¯
5. â­ï¸ é‡åˆ°é—®é¢˜æŸ¥é˜…æ•…éšœæ’é™¤ç« èŠ‚

**é¢„è®¡æ—¶é—´çº¿**ï¼š
- Step 1-2: 1 å°æ—¶ï¼ˆåœºå‡½æ•° + æ­¥è¿›ï¼‰
- Step 3: 30 åˆ†é’Ÿï¼ˆæ³•çº¿ + å…‰ç…§ï¼‰
- Step 4: 1 å°æ—¶ï¼ˆç£¨ç ‚è´¨æ„Ÿï¼Œå«è°ƒä¼˜ï¼‰
- Step 5: 30 åˆ†é’Ÿï¼ˆè¾¹ç¼˜é€æ˜ï¼‰
- Step 6: 30 åˆ†é’Ÿï¼ˆUI æ§åˆ¶ï¼‰
- **æ€»è®¡**: 3-4 å°æ—¶

**é£é™©æç¤º**ï¼š
- å™ªå£°ç»‘å®šåˆ°é”™è¯¯ç©ºé—´åŸŸï¼ˆview-space vs world-spaceï¼‰æ˜¯æœ€å¸¸è§çš„å¤±è´¥åŸå› 
- æ¯ä¸ª Step å¿…é¡»éªŒè¯é€šè¿‡å†ç»§ç»­ï¼Œé¿å…é—®é¢˜ç´¯ç§¯

---

## ğŸ“ å¤‡æ³¨

- æœ¬æ–‡æ¡£åŸºäº `RAYMARCHING_INTEGRATION_PLAN.md` Phase 6 ç« èŠ‚
- å‚è€ƒå®ç°ï¼š`ref/Shader3/spCode.js`
- å½“å‰ä»£ç ï¼š`src/components/MetaCanvas.tsx`
- å¦‚é‡åˆ°æ–‡æ¡£æœªè¦†ç›–çš„é—®é¢˜ï¼Œå‚è€ƒæ•´åˆè®¡åˆ’çš„æ•…éšœæ’é™¤æŒ‡å—ï¼ˆ642-716 è¡Œï¼‰

---

## âš ï¸ å…³é”®é£é™©ä¸ç¼“è§£ç­–ç•¥

### ğŸ”´ é«˜é£é™©é¡¹ï¼ˆå¿…é¡»æ­£ç¡®ï¼‰

| é£é™© | åæœ | ç¼“è§£ç­–ç•¥ | éªŒè¯æ–¹æ³• |
|------|------|---------|---------|
| **å™ªå£°ç»‘å®šåˆ° world-space** | äº‘é›¾æ„Ÿï¼Œè´¨æ„Ÿé”™è¯¯ | âœ… å¿…é¡»ç”¨ `rd`ï¼ˆview-spaceï¼‰ | è§†çº¿ç§»åŠ¨æ—¶é¢—ç²’å˜åŒ–ï¼Œä½†åŒè§†è§’ç¨³å®š |
| **ä¸¤ä¸ª epsilon å…±ç”¨** | æ³•çº¿æŠ–åŠ¨/é»‘æ´ | âœ… NORMAL_EPS = 2-4 * HIT_EPS | è¾“å‡ºæ³•çº¿é¢œè‰²ï¼Œæ£€æŸ¥æ— è·³å˜ |
| **ç¼ºå°‘æ­¥è¿›æŠ¤æ ** | è–„å£³æ–­è£‚/èœ—ç‰›èµ° | âœ… clamp(d, MIN_STEP, MAX_STEP) | æ å°„è§’å¤„æ— ç‚¹çŠ¶ï¼Œæ€§èƒ½æ­£å¸¸ |

### ğŸŸ¡ ä¸­é£é™©é¡¹ï¼ˆå¯èƒ½è¸©å‘ï¼‰

| é£é™© | åæœ | ç¼“è§£ç­–ç•¥ |
|------|------|---------|
| smooth-union ç±»å‹ä¸åŒ¹é… | èåˆä¸è‡ªç„¶ | ä¿ç•™åŒå¼€å…³ï¼ˆå¤šé¡¹å¼ vs æŒ‡æ•°ï¼‰|
| å‘½ä¸­é˜ˆå€¼å¤ªä¸¥æ ¼ | Miss ç‡é«˜ | å…ˆç”¨ HIT_EPS=1e-3ï¼Œå†é€æ­¥é™ä½ |
| æ€§èƒ½ç“¶é¢ˆ | FPS < 30 | å…ˆé™æ­¥æ•°ï¼Œå†é™åˆ†è¾¨ç‡ |

### ğŸŸ¢ ä½é£é™©é¡¹ï¼ˆæ˜“è§£å†³ï¼‰

- è¾¹ç¼˜é€æ˜åº¦ä¸åˆé€‚ â†’ è°ƒæ•´ Fresnel å¹‚æ¬¡
- é¢—ç²’è¿‡ç²—/è¿‡ç»† â†’ è°ƒæ•´ grainPow å’Œ noiseScale
- èåˆå®½åº¦ä¸ç†æƒ³ â†’ è°ƒæ•´ blendK

---

## ğŸ“ å®æ–½å»ºè®®ï¼ˆç»éªŒæ€»ç»“ï¼‰

### 1. æ¸è¿›å¼éªŒè¯ï¼ˆå¿…é¡»ï¼ï¼‰

```
Step 0 â†’ Step 1 â†’ Step 2ï¼ˆæ´‹çº¢çƒï¼‰ â†’ Step 3ï¼ˆç™½è‰²å…‰ç…§çƒï¼‰ â†’ Step 4ï¼ˆç£¨ç ‚çƒï¼‰ â†’ Step 5ï¼ˆåŠé€æ˜çƒï¼‰
   â†“        â†“          â†“                  â†“                    â†“                 â†“
  å¼€å…³    åœºå‡½æ•°      å‘½ä¸­ç¨³å®š            æ³•çº¿æ­£ç¡®             è´¨æ„Ÿåˆ°ä½           å®Œæˆ
```

**æ¯ä¸ªç®­å¤´éƒ½å¿…é¡»éªŒè¯é€šè¿‡å†ç»§ç»­**ï¼Œå¦åˆ™é—®é¢˜ä¼šç´¯ç§¯éš¾ä»¥å®šä½ã€‚

### 2. æœ€å°å›æ»šå•ä½

æ¯ä¸ª Step å®Œæˆåç«‹å³ git commitï¼š
```bash
git add .
git commit -m "Phase 6 Step X: [åŠŸèƒ½æè¿°]"
```

å‡ºé—®é¢˜æ—¶å¯å¿«é€Ÿå›é€€åˆ°ä¸Šä¸€ä¸ªç¨³å®šçŠ¶æ€ã€‚

### 3. è°ƒè¯•ä¼˜å…ˆçº§

é‡åˆ°é—®é¢˜æ—¶çš„æ’æŸ¥é¡ºåºï¼š

1. **å…ˆæ£€æŸ¥å¼€å…³**ï¼ˆUSE_SDF_METHOD, NOISE_SPACE ç­‰ï¼‰
2. **å†æ£€æŸ¥å¸¸é‡**ï¼ˆHIT_EPS, NORMAL_EPS, MIN_STEP, MAX_STEPï¼‰
3. **è¾“å‡ºè°ƒè¯•é¢œè‰²**ï¼š
   - å‘½ä¸­ï¼šæ´‹çº¢è‰² `vec4(1, 0, 1, 1)`
   - æ³•çº¿ï¼š`vec4(n * 0.5 + 0.5, 1)`
   - è·ç¦»åœºï¼š`vec4(vec3(d), 1)` ï¼ˆç°åº¦ï¼‰
4. **æ£€æŸ¥ uniform ä¼ é€’**ï¼ˆConsole è¾“å‡ºå€¼ï¼‰
5. **æœ€åè°ƒæ•´å‚æ•°**ï¼ˆblendK, grainPow ç­‰ï¼‰

### 4. å‚æ•°è°ƒä¼˜é¡ºåº

**ä¸è¦ä¸€æ¬¡æ€§è°ƒæ‰€æœ‰å‚æ•°ï¼** æŒ‰ä¼˜å…ˆçº§é€ä¸ªè°ƒï¼š

```
å‘½ä¸­ç¨³å®šï¼ˆHIT_EPS, MIN/MAX_STEPï¼‰
  â†“
æ³•çº¿æ­£ç¡®ï¼ˆNORMAL_EPSï¼‰
  â†“
èåˆè‡ªç„¶ï¼ˆblendK, SMOOTH_UNION_TYPEï¼‰
  â†“
ç£¨ç ‚è´¨æ„Ÿï¼ˆgrainPow, noiseScaleï¼‰
  â†“
è¾¹ç¼˜é€æ˜ï¼ˆfresnelPow, alpha rangeï¼‰
```

### 5. æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

**ä¼˜åŒ–æ—¶æœº**ï¼šåŠŸèƒ½å…¨éƒ¨å®Œæˆåå†ä¼˜åŒ–ï¼ˆè¿‡æ—©ä¼˜åŒ–æ˜¯ä¸‡æ¶ä¹‹æºï¼‰

**ä¼˜åŒ–é¡ºåº**ï¼š
1. é™ä½æ­¥æ•°ï¼ˆmaxSteps: 256 â†’ 128 â†’ 64ï¼‰
2. é™ä½åˆ†è¾¨ç‡ï¼ˆrenderScale: 1.0 â†’ 0.75 â†’ 0.5ï¼‰
3. ä¼˜åŒ– AABBï¼ˆæ”¶ç´§åŒ…å›´ä½“ï¼‰
4. ç©ºé—´åŠ é€Ÿï¼ˆç½‘æ ¼/å…«å‰æ ‘ï¼Œå¤æ‚åº¦é«˜ï¼‰

---

## ğŸš€ ç«‹å³è¡ŒåŠ¨ï¼ˆå¼€å§‹å®æ–½ï¼‰

### å‡†å¤‡æ¸…å•ï¼ˆå¼€å§‹å‰ç¡®è®¤ï¼‰

- [ ] å·²é˜…è¯»å®Œæ•´ TODO æ–‡æ¡£
- [ ] å·²é˜…è¯» `RAYMARCHING_INTEGRATION_PLAN.md` Phase 6 ç« èŠ‚
- [ ] å·²æŸ¥çœ‹ `ref/Shader3/spCode.js` å‚è€ƒä»£ç 
- [ ] å·²å¤‡ä»½å½“å‰ä»£ç ï¼ˆgit commitï¼‰
- [ ] å¼€å‘ç¯å¢ƒæ­£å¸¸ï¼ˆnpm run dev è¿è¡Œæ­£å¸¸ï¼‰
- [ ] æµè§ˆå™¨ Console å·²æ‰“å¼€ï¼ˆå‡†å¤‡æŸ¥çœ‹é”™è¯¯/æ—¥å¿—ï¼‰

### ç¬¬ä¸€æ­¥ï¼šæ·»åŠ è°ƒè¯•å¼€å…³ï¼ˆStep 0.3ï¼‰

æ‰“å¼€ `src/components/MetaCanvas.tsx`ï¼Œåœ¨ Fragment Shader é¡¶éƒ¨æ·»åŠ ï¼š

```glsl
// ============== è°ƒè¯•å¼€å…³ï¼ˆä¾¿äºå›æ»šå¯¹æ¯”ï¼‰ ==============
#define USE_SDF_METHOD 1        // å…ˆè®¾ä¸º 0ï¼ŒéªŒè¯é€šè¿‡åæ”¹ä¸º 1
#define SMOOTH_UNION_TYPE 0
#define NOISE_SPACE 0
#define DEBUG_PERF 0

// ============== å¸¸é‡é…ç½® ==============
const float HIT_EPS = 1e-4;
const float NORMAL_EPS = 4e-4;
const float MIN_STEP = 1e-3;
const float MAX_STEP = 0.5;
```

ä¿å­˜ï¼Œç¡®è®¤ç¼–è¯‘é€šè¿‡ï¼Œç„¶åå¼€å§‹ Step 1ã€‚

---

**æœ€åæ›´æ–°**ï¼š2025-10-10ï¼ˆè¡¥å……æ˜“é”™é¡¹å’Œå®æ–½å»ºè®®ï¼‰
**çŠ¶æ€**ï¼šğŸ“„ æ–‡æ¡£å·²å®Œæˆï¼Œå¾…å®æ–½ä»£ç 
**è´£ä»»äºº**ï¼šå¼€å‘å›¢é˜Ÿ
