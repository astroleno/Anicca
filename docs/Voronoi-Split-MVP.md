# Voronoi 分裂 + 弥散球 MVP 设计说明（只读实现指南）

> 目标：以 UV/球面 Voronoi + (d2−d1) 驱动弥散参数 + splitProgress 缓动，呈现“连续、生长、分枝”的分裂观感（branch），而非几何断裂（break）。

---

## 1. 设计原则（Why）
- 连续性：分裂是“势能重分配 + 轻微扰动重排”，几何一体不破，避免断面/穿帮。
- 语义一致：契合“无相（Anicca）”——一念生三，分而不散，终归于一。
- 移动端友好：UV 参数域做 Voronoi，避免体积步进开销；DPR ≤ 2。

---

## 2. 空间与标量（What）
- 空间选择：UV/球面参数域 Voronoi（站点在球面均匀分布→投回 UV；U 环向 wrap，V 极区轻微噪声补偿）。
- 标量：
  - d1：到最近站点距离；d2：到次近站点距离。
  - 边界强度 s = clamp((d2 − d1)/K, 0, 1)，s 越小越靠近分界。
- 用途：用 s 驱动“厚度/雾度（近似 transmission/absorption）/粗糙度/自发光/IOR 微扰”。

---

## 3. 分裂控制量（How）
- splitProgress ∈ [0,1]：分裂进度，缓动可逆（easeInOutCubic，默认 600ms）。
- 站点控制：
  - 位置插值：从主胞腔中心/边界附近外推；所有站点共享同一低频噪声场方向，形成整体一致性。
  - 权重（Power Diagram 势）：随 splitProgress 增长；接近拓扑事件（边生成/消失）自动降速。
- K 自适应：K(t) 在分裂期略小、稳态略大，使边界更柔和且不虚胖。

---

## 4. 动画编舞（Timeline）
- 萌生 t∈[0,0.3]：边界预热（厚度↑、粗糙度↑、自发光微↑），新站点权重小。
- 分裂 t∈[0.3,0.7]：势能转移，边界迁移重排；临界处降速到 ~0.6×。
- 稳态 t∈[0.7,1]：参数回落；可做 1–2 次轻微 Lloyd 松弛圆润角点。
- 合并：沿同轨迹反向；进行中反向需剩余时长 ≥ 120ms，避免抖动。

---

## 5. 参数与默认值（可微调）
- 站点数：3（后续 ≤ 5）。
- 动画时长：600ms，可逆缓动。
- K：0.2 基准；分裂期 K↓、稳态 K↑（随 t 轻微调制）。
- 面积目标：主:子 ≈ 60:40 或 55:45。
  - 闭环：每 3–5 帧估算分区面积，按误差微调权重（步长 ≤ 2–3%）。
- 移动端：DPR ≤ 2；必要时用 2 层“假壳体”增强“奶感”，不做体积步进。

---

## 6. 与当前壳子契合点（现状 OK）
- 组件：`src/app/page.tsx` 使用 `Shader3Canvas`。
- 生命周期：懒加载 `shader-park-core`；StrictMode 防重复初始化；DPR 自适应；事件清理完整。
- Uniform 管线：`click/buttonHover/split/splitProgress` 已注入；splitProgress 由 RAF 缓动驱动。

---

## 7. 实施步骤（落地顺序，写在 spCode 内）
1) UV Voronoi 核心（参数域）
   - 站点在球面均匀采样 → 投回 UV；U 环向 wrap，V 极区加极弱蓝噪点抖动。
   - 计算 d1/d2，得到 s = clamp((d2 − d1)/K(t), 0, 1)。
2) 参数映射（弥散外观）
   - 使用 s 驱动：厚度/雾度↑（边界>内部）、粗糙度↑（边界软）、自发光微↑、IOR 微扰。
   - 亮度与厚度做微反相关补偿，维持“感知体积”稳定。
3) 分裂编舞与守恒
   - splitProgress 控制站点位置与权重插值；靠近拓扑事件自动降速。
   - 面积反馈回路：每 3–5 帧微调权重（≤ 2–3%），逼近目标占比。
4) 稳定性与防抖
   - 最小胞腔阈值；每帧最大变化量限制；反向补间阈值 ≥ 120ms。
5) 验证与日志
   - 控制台输出：站点数/权重/K(t)/面积估计；阶段打点（萌生/分裂/稳态）。

---

## 8. 风险与对策
- 极区拉伸/接缝：球面→UV 映射后做 wrap 与轻微噪声补偿；必要时 1–2 次 Lloyd 松弛。
- 边界跳闪：拓扑事件处降速；权重步长限制；三段式节奏明确。
- 性能：站点 ≤ 5、maxIterations ≤ 8；避免每步高次幂；移动端 DPR ≤ 2。

---

## 9. 扩展路线（演进）
- 更“奶”的体积感：2–6 层“假壳体”先行（2.5D），再考虑体积 Voronoi 与步进采样。
- 语义分区：按“顺流/逆流/止语”给分区不同配色/厚度曲线与微动效。
- 交互：hover/press 映射到某分区权重短暂扰动，呈现“念头被触发”的回声。

---

## 10. 实施清单（无代码）
- 空间：✔ UV Voronoi（U wrap，V 极区补偿）
- 标量：✔ d1/d2 与 s 曲线（K 自适应）
- 分裂：✔ splitProgress→站点/权重，三段式与减速策略
- 外观：✔ s→厚度/粗糙/自发光/IOR 微扰 + 亮度-厚度补偿
- 守恒：✔ 面积反馈闭环（3–5 帧/次，≤ 2–3% 步长）
- 移动端：✔ DPR ≤ 2、站点 ≤ 5、先不上体积步进
- 交互：✔ 反向补间阈值 ≥ 120ms、同一低频噪声场方向一致性

---

如需我直接接入 spCode：我会在保持 `Shader3Canvas` 不动的前提下，增量实现上述 1→5 步，并开放可调参数（站点数、K 基准、K(t) 调制、分裂时长、面积目标、亮度-厚度补偿系数）。
