# Anicca 分形+Fork/嫁接+融合视觉方案设计

## 项目背景分析

### 现有技术架构
- **前端框架**: Next.js 15 + React 18 + TypeScript
- **渲染引擎**: Shader Park Core + WebGL (单管线策略)
- **交互系统**: 鼠标点击、悬停、键盘控制
- **动画系统**: RequestAnimationFrame + 缓动函数
- **状态管理**: React Hooks + 本地状态
- **HUD系统**: HTML/CSS叠加层 (不参与WebGL折射)

### 现有视觉特征
- **Voronoi连续分枝系统**: 已实现UV空间分区和基础分裂动画
- **三段式动画编舞**: 萌生/分裂/稳态三个阶段
- **磁流体质感**: 基于噪声的有机变形
- **禅意美学**: 无相、留白、自然的视觉语言
- **移动端优化**: DPR≤2的性能约束

## 1. 视觉概念设计

### 1.1 核心理念：分形辩证法

基于黑格尔辩证法的三阶段演进，结合分形几何的自相似特性：

```
正题 (Thesis) → 反题 (Antithesis) → 合题 (Synthesis)
   ↓              ↓                ↓
深入路径        反格式塔路径      辩证统一
分形深化        分形解构        分形融合
```

### 1.2 视觉隐喻系统

#### 分形树隐喻
- **根系统**: 核心思想/问题
- **枝干**: 推理路径
- **叶片**: 具体想法/节点
- **花朵**: 创新突破点
- **种子**: 可嫁接的新枝

#### 磁流体隐喻
- **流动性**: 思维的可塑性
- **磁性**: 概念的吸引力
- **变形**: 嫁接过程中的形态变化
- **融合**: 不同思想的有机结合

## 2. 核心视觉元素定义

### 2.1 分形球体系统

#### 主球体 (Core Sphere)
```glsl
// 位置：场景中心
// 半径：0.4-0.6 (动态响应)
// 材质：半透明磁流体
// 特征：内部有复杂的分形纹理
```

#### 子球体 (Child Spheres)
```glsl
// 数量：3-7个 (根据分形阶数)
// 排列：基于黄金角度的螺旋分布
// 大小：递减序列 (1.0, 0.618, 0.382, 0.236...)
// 连接：能量管道/分形枝干
```

#### 微分形颗粒 (Micro-fractals)
```glsl
// 数量：50-200个粒子
// 分布：主球体周围的云雾状
// 动态：布朗运动 + 磁场吸引
// 生命周期：萌生→成长→消散
```

### 2.2 Voronoi分区系统

#### 三维Voronoi细胞
```glsl
// 种子点：基于分形位置的动态生成
// 边界：发光的能量线
// 材质：渐变透明度
// 动态：随分形演化而变形
```

#### UV映射分区
```glsl
// 球面UV：2D Voronoi图
// 边界强度：sEdge = (db - da) / K
// 材质映射：edgeBoost = pow(1.0 - sEdge, 1.2)
// 动态：K值随分裂阶段自适应
```

### 2.3 连接系统

#### 分形枝干 (Fractal Branches)
```glsl
// 起点：主球体表面
// 终点：子球体中心
// 形态：L-System生成
// 截面：圆形渐变到椭圆
// 材质：半透明发光
```

#### 能量管道 (Energy Conduits)
```glsl
// 形态：贝塞尔曲线
// 截面：动态半径
// 流动：粒子沿管道运动
// 颜色：HSV循环渐变
```

## 3. 动画系统设计

### 3.1 三段式动画编舞

#### 萌生阶段 (Emergence: 0-30%)
```glsl
// 时间：0-3秒
// 主球体：脉动呼吸 (R0 = 0.5 + 0.05 * sin(time * 2))
// 子球体：从主球体表面萌发
// 粒子：围绕主球体旋转聚集
// 颜色：冷色调 → 暖色调渐变
```

#### 分裂阶段 (Split: 30-70%)
```glsl
// 时间：3-7秒
// 主球体：逐渐收缩
// 子球体：沿分形轨迹分离
// 连接：能量管道逐渐形成
// 边界：Voronoi边界强化
```

#### 稳态阶段 (Stabilization: 70-100%)
```glsl
// 时间：7-10秒
// 位置：达到最终分形布局
// 材质：透明度稳定
// 动态：微呼吸动画
// 交互：准备嫁接状态
```

### 3.2 缓动函数系统

#### 基础缓动函数
```glsl
// easeInOutCubic: 主要过渡动画
float easeInOutCubic(float x) {
    return x < 0.5 ? 4.0 * x * x * x : 1.0 - pow(-2.0 * x + 2.0, 3.0) / 2.0;
}

// easeOutElastic: 回弹效果
float easeOutElastic(float x) {
    float c4 = (2.0 * PI) / 3.0;
    return x == 0.0 ? 0.0 : x == 1.0 ? 1.0 : pow(2.0, -10.0 * x) * sin((x * 10.0 - 0.75) * c4) + 1.0;
}
```

#### 分形缓动
```glsl
// 基于分形的缓动函数
float fractalEase(float t, float iterations) {
    float result = 0.0;
    float amplitude = 1.0;
    float frequency = 1.0;

    for(float i = 0.0; i < iterations; i++) {
        result += amplitude * sin(frequency * t * PI);
        amplitude *= 0.5;
        frequency *= 2.0;
    }

    return result;
}
```

### 3.3 嫁接动画

#### 抽离动画 (Extraction)
```glsl
// 1. 子球体从主球体表面分离
// 2. 能量管道逐渐拉伸
// 3. 粒子跟随子球体运动
// 4. 边界重新计算
```

#### 移动动画 (Migration)
```glgl
// 1. 子球体沿贝塞尔曲线移动
// 2. 能量管道动态变形
// 3. 粒子流沿管道运动
// 4. 磁场效果吸引/排斥
```

#### 融合动画 (Fusion)
```glsl
// 1. 目标球体表面软化
// 2. 嫁接球体逐渐融入
// 3. 能量脉冲扩散效果
// 4. 新的分形结构生成
```

## 4. 交互视觉反馈

### 4.1 鼠标交互

#### 悬停状态 (Hover)
```glsl
// 球体：轻微放大 (+5%)
// 边界：发光强化 (+20%)
// 粒子：吸引效果
// 颜色：暖色调偏移
```

#### 点击操作 (Click)
```glsl
// 脉冲：从点击位置扩散
// 分裂：触发子球体分离
// 变形：局部扰动效果
// 反馈：触觉震动(移动端)
```

#### 拖拽操作 (Drag)
```glgl
// 实时：球体跟随鼠标
// 轨迹：留下粒子尾迹
// 磁场：显示吸引区域
// 吸附：目标位置高亮
```

### 4.2 键盘交互

#### 快捷键系统
```
S: 分裂/合并切换
F: 触发分形深化
G: 显示/隐藏网格
R: 重置到初始状态
1-5: 调整分形阶数
Space: 暂停/播放动画
```

### 4.3 触摸交互 (移动端)

#### 手势识别
```glsl
// 单指点击：选择球体
// 双指缩放：调整视野
// 双指旋转：旋转视角
// 长按：触发嫁接模式
// 滑动：快速切换分支
```

## 5. 色彩与材质方案

### 5.1 色彩系统

#### 主色调 (基于HSB)
```glsl
// 基础色相：H = 0.55 (青蓝色)
// 饱和度：S = 0.85 (高饱和)
// 明度：B = 1.0 (高明度)
// 动态：H随时间缓慢循环
```

#### 辅助色系
```glsl
// 暖色系：H = 0.08 (橙黄色)
// 冷色系：H = 0.58 (蓝紫色)
// 中性色：H = 0.0/0.33/0.67 (RGB基色)
// 过渡：基于smoothstep的插值
```

#### 情感色彩映射
```glgl
// 正题(深入)：冷色调 (蓝紫系)
// 反题(反格式塔)：暖色调 (橙红系)
// 合题(融合)：渐变色 (冷暖交融)
// 中性状态：灰调色 (低饱和度)
```

### 5.2 材质系统

#### 磁流体材质
```glsl
// 基础属性：
float metallic = 0.2;      // 金属感
float roughness = 0.3;     // 粗糙度
float transmission = 0.8;  // 透光性
float thickness = 0.1;     // 厚度

// 动态属性：
float deformation = fbm(position * 2.0 + time * 0.1);
vec3 normal perturbed = normal + deformation * 0.1;
```

#### 发光材质
```glgl
// 边缘发光：
float rim = pow(1.0 - dot(normal, viewDir), 2.0);
vec3 emission = baseColor * rim * emissionStrength;

// 内部发光：
float innerGlow = fbm(position * 3.0) * 0.5 + 0.5;
vec3 coreEmission = baseColor * innerGlow * coreStrength;
```

#### 半透明材质
```glgl
// 体积渲染：
float density = calculateDensity(position);
float transmittance = exp(-density * stepLength);
vec3 inscatter = calculateInscatter(position, viewDir);
```

### 5.3 粒子材质

#### 基础粒子
```glgl
// 形状：点精灵
// 大小：距离衰减
// 颜色：基于生命周期
// 透明度：fade-in/fade-out
```

#### 能量粒子
```glgl
// 形状：运动模糊
// 轨迹：速度线渲染
// 颜色：HSV循环
// 发光：additive blending
```

## 6. 分层次级设计

### 6.1 空间层级

#### 核心层 (Layer 0)
```glgl
// 内容：主球体
// 渲染顺序：最先
// 深度测试：关闭
// 混合模式：alpha混合
```

#### 分形层 (Layer 1)
```glgl
// 内容：子球体、连接枝干
// 渲染顺序：中间
// 深度测试：开启
// 混合模式：additive混合
```

#### 粒子层 (Layer 2)
```glgl
// 内容：粒子系统
// 渲染顺序：最后
// 深度测试：关闭
// 混合模式：additive混合
```

#### 界面层 (Layer 3)
```glgl
// 内容：UI元素、文字
// 渲染顺序：最前
// 深度测试：关闭
// 混合模式：正常混合
```

### 6.2 LOD (Level of Detail) 系统

#### 距离LOD
```glgl
// 近距离 (z < 2.0)：完整细节
// 中距离 (2.0 ≤ z < 5.0)：中等细节
// 远距离 (z ≥ 5.0)：简化几何
```

#### 性能LOD
```glgl
// 高性能 (FPS ≥ 60)：完整效果
// 中性能 (30 ≤ FPS < 60)：减少粒子
// 低性能 (FPS < 30)：基础渲染
```

#### 移动端LOD
```glgl
// DPR ≤ 1：基础质量
// 1 < DPR ≤ 2：中等质量
// DPR > 2：高质量 (仅桌面端)
```

## 7. 渲染管线实现

### 7.1 Shader Park渲染规范（MVP）

#### 单场景渲染策略
```glsl
// Shader Park 单管线约束
// 禁用多场景切换，专注单一WebGL上下文
setMaxIterations(8); // 性能约束
blend(0.35); // 固定混合系数
```

#### 透明策略：薄壳+边缘增亮
```glsl
// 薄壳式透明：不使用真体积渲染
shape(() => {
  rotateX(PI/2);
  mixGeo(click); // 几何混合替代透明
  sphere(R_main);
})();

// 边缘增亮效果
let rim = pow(1.0 - dot(normal, viewDir), 2.0);
let edgeBoost = pow(1.0 - sEdge, 1.2) * boundaryLight;
```

#### HUD策略：HTML/CSS叠加
```typescript
// HUD组件不参与WebGL渲染
// 使用绝对定位的HTML元素
<div style={{ position: 'absolute', zIndex: 10 }}>
  <button>分裂/合并</button>
  <div>站点数:{seedCount}</div>
</div>
```

### 7.2 Three.js渲染规范（后续扩展）

#### 多Pass渲染策略
```javascript
// 预留Three.js扩展路径
// Pass 0: 深度预写
// Pass 1: 弥散壳渲染
// Pass 2: 后处理效果
```

#### 分形噪声系统（基于shader3.ts）
```glsl
// 对齐现有shader3.ts的实现
function fbm(p){
    return vec3(
      noise(p),
      noise(p + offset),
      noise(p + offset * 2.0)
    );
}

// 背景噪声（保持现有实现）
let s = getRayDirection();
let n = sin(fbm(s + vec3(0.0, 0.0, -time * 0.1)) * 2.0) * 0.36 + 0.75;
n = pow(n, vec3(8.0));
```

#### Voronoi分区系统（基于shader3.ts）
```glsl
// 对齐现有shader3.ts的UV空间Voronoi实现
let dir = normalize(getRayDirection());
let U = atan(dir.z, dir.x) / (2.0 * PI) + 0.5;
let V = asin(clamp(dir.y, -1.0, 1.0)) / PI + 0.5;

// 三站点Voronoi（3-5站点可调）
let spread = mix(0.02, 0.18, clamp(tSpread, 0.0, 1.0));
let p0 = vec2(cU + spread*cos(ang0), cV + spread*sin(ang0));
let p1 = vec2(cU + spread*cos(ang1), cV + spread*sin(ang1));
let p2 = vec2(cU + spread*cos(ang2), cV + spread*sin(ang2));

// 边界强度计算
let K = mix(0.16, 0.24, settleW) - 0.02 * splitW;
let sEdge = clamp((db - da) / K, 0.0, 1.0);
let edgeBoost = pow(1.0 - sEdge, 1.2);
```

### 7.4 React组件架构

#### 状态管理（基于Shader3Canvas）
```typescript
// 对齐现有Shader3Canvas.tsx的状态结构
interface Shader3CanvasState {
  // 分裂控制
  isSplitTarget: boolean;
  splitProgress: number; // [0,1]
  seedCount: number; // {3,4,5}
  autoPlay: boolean;
  showEdges: boolean;

  // 交互状态（已实现）
  click: number; // [0,1]
  buttonHover: number; // [0,1]

  // 动画参数
  startTime: number;
  animationDuration: number;
}
```

#### 事件处理（基于Shader3Canvas）
```typescript
// 对齐现有Shader3Canvas.tsx的事件处理
// 鼠标事件：mousedown/mouseup/mouseenter/mouseleave
const onMouseDown = () => { clickVal = 1.0; };
const onMouseUp = () => { clickVal = 0.0; };
const onMouseEnter = () => { hoverVal = 1.0; };
const onMouseLeave = () => { hoverVal = 0.0; };

// 键盘事件：S键切换分裂
const onKeyDown = (e: KeyboardEvent) => {
  if (e.key.toLowerCase() === 's') {
    setIsSplitTarget(v => !v);
    startSplitAnimation(isSplitTarget ? 1 : 0, 600);
  }
};
```

### 7.3 性能优化策略

#### Shader Park性能约束
```glsl
// 移动端优化：限制迭代次数和复杂度
setMaxIterations(8); // 固定上限
setQuality('medium'); // 质量预设

// CPU优化：避免频繁的WebGL状态切换
const dpr = Math.min(window.devicePixelRatio || 1, 2);
// 对象复用，避免内存分配
```

## 8. 参数定义与性能指标

### 8.1 核心参数表（基于shader3.ts）

#### 动画控制参数
| 参数名 | 类型 | 范围 | 描述 | 默认值 |
|--------|------|------|------|--------|
| `splitProgress` | float | [0,1] | 分裂进度，控制三段式动画 | 1.0 |
| `isSplitTarget` | boolean | {true,false} | 目标分裂状态 | true |
| `autoPlay` | boolean | {true,false} | 自动播放模式 | false |

#### 几何参数
| 参数名 | 类型 | 范围 | 描述 | 默认值 |
|--------|------|------|------|--------|
| `seedCount` | int | {3,4,5} | Voronoi站点数 | 3 |
| `R_main` | float | [0.45,0.6] | 主球半径（动态） | 0.5 + n.x*0.035 |
| `R_child` | float | [0.18,0.22] | 子球半径比例 | 0.22*R_main |
| `spread` | float | [0.02,0.18] | 分裂距离 | mix(0.02,0.18,t) |

#### 视觉效果参数
| 参数名 | 类型 | 范围 | 描述 | 默认值 |
|--------|------|------|------|--------|
| `edgeBoost` | float | [0,0.2] | 边缘增亮强度 | pow(1.0-sEdge,1.2) |
| `boundaryLight` | float | [0.24,0.96] | 边界发光系数 | 0.6*(0.4+0.6*splitW) |
| `K` | float | [0.14,0.24] | Voronoi边界软化系数 | mix(0.16,0.24,settleW)-0.02*splitW |

#### 交互参数
| 参数名 | 类型 | 范围 | 描述 | 默认值 |
|--------|------|------|------|--------|
| `click` | float | [0,1] | 鼠标点击状态 | 0.0 |
| `buttonHover` | float | [0,1] | 按钮悬停状态 | 0.0 |
| `showEdges` | boolean | {true,false} | 显示分区线 | false |

#### 算法约束参数
| 参数名 | 类型 | 范围 | 描述 | 默认值 |
|--------|------|------|------|--------|
| `setMaxIterations` | int | {6,8,10} | 最大迭代次数 | 8 |
| `blend` | float | [0,1] | 混合系数 | 0.35 |
| `offset` | float | [0.05,0.15] | 噪声偏移 | 0.1 |

### 8.2 Uniform/Inputs映射表

#### Shader Park输入映射（基于Shader3Canvas.tsx）
| React State | Shader Input | 数据类型 | 更新频率 | 描述 |
|-------------|--------------|----------|----------|------|
| `clickVal` | `click` | float | 事件驱动 | 鼠标按下时为1.0，抬起为0.0 |
| `hoverVal` | `buttonHover` | float | 事件驱动 | 鼠标悬停时为1.0，离开为0.0 |
| `splitRef.current` | `split` | float | 实时 | 向后兼容的分裂状态 |
| `splitRef.current` | `splitProgress` | float | 实时 | 主要的分裂进度参数 |
| `seedCount` | `seedCount` | int | 用户操作 | Voronoi站点数量（3-5） |
| `showEdges` | `showEdges` | int | 用户操作 | 调试模式，显示分区线 |

#### 内置Shader Park变量
| Shader变量 | 类型 | 来源 | 描述 |
|-------------|------|------|------|
| `time` | float | 系统注入 | 动画时间戳 |
| `mouse` | vec2 | 系统注入 | 鼠标位置（未使用） |
| `getRayDirection()` | vec3 | 系统函数 | 当前射线方向 |

#### 数据流验证
```typescript
// Shader3Canvas.tsx中的实际传递代码
const uniforms = () => ({
  click: clickVal,           // ✅ 对应shader中的click
  buttonHover: hoverVal,     // ✅ 对应shader中的buttonHover
  split: splitRef.current,   // ✅ 向后兼容
  splitProgress: splitRef.current, // ✅ 主要参数
  seedCount: seedCount,      // ✅ 整型参数
  showEdges: showEdges ? 1 : 0, // ✅ 布尔转整型
});
```

### 8.3 性能KPI基准

#### 目标设备基准
- **移动端基准**: iPhone 12 / A14仿生芯片或同等级别
- **桌面端基准**: Intel i5-8代 / AMD Ryzen 5或同等级别
- **内存基准**: 4GB RAM（移动端）, 8GB RAM（桌面端）

#### 渲染性能指标
- **分辨率约束**: DPR ≤ 2，总像素 ≤ 1.3M
- **帧率目标**:
  - 平均FPS ≥ 30
  - 95th百分位FPS ≥ 24
  - 最低FPS ≥ 15（短暂可接受）
- **渲染时间**: 单帧 ≤ 16ms（60fps目标）

#### 算法复杂度约束
- **最大迭代次数**: setMaxIterations ≤ 10
- **Voronoi站点数**: seedCount ∈ {3,4,5}
- **几何体数量**: ≤ 5k（MVP阶段）

### 8.2 渲染优化

#### 批量渲染
```glsl
// 实例化渲染相同几何体
// 合并小物体减少draw calls
// 使用纹理图集减少绑定切换
// GPU Driven渲染管线
```

#### 遮挡剔除
```glgl
// 视锥体剔除
// 背面剔除
// 遮挡查询剔除
// 距离剔除
```

### 8.3 内存优化

#### 纹理压缩
```glgl
// ASTC/ETC2压缩格式
// 纹理流式加载
// 纹理图集合并
// Mipmap生成
```

#### 几何优化
```glgl
// Level of Detail系统
// 几何压缩
// 实例化渲染
// 程序化生成
```

### 8.3 移动端优化

#### 渲染优化
```glgl
// 降低分辨率 (DPR ≤ 2)
// 减少粒子数量
// 简化着色器复杂度
// 降低LOD切换距离
```

#### 交互优化
```glgl
// 防抖动处理
// 触摸事件优化
// 减少重绘区域
// 异步加载资源
```

## 9. 实现路线图

### Phase 1: 基础分形系统 (2周)
**目标**: Shader Park单管线MVP - 三段式编舞、Voronoi分区、三球分裂、薄壳式"弥散错觉"

**约束条件**:
- 禁用: p5.js、GLTF、真体积/多pass、Compute Shader
- 专注: 单场景、透明策略用薄壳+边缘增亮

**Week 1**:
- [ ] 优化现有shader3.ts的三段式动画系统
- [ ] 实现薄壳式透明策略（边缘增亮）
- [ ] 完善Voronoi分区边界调色机制

**Week 2**:
- [ ] 实现三球分裂的体积守恒效果
- [ ] 优化移动端DPR≤2的性能约束
- [ ] 添加HTML/CSS HUD系统（不参与折射）

### Phase 2: 交互系统优化 (2周)
**目标**: 基于现有Shader3Canvas组件优化交互体验

**Week 3-4**:
- [ ] 优化鼠标交互响应（click、hover状态）
- [ ] 完善键盘控制（S键切换分裂）
- [ ] 改进触摸手势支持（移动端友好）
- [ ] 优化splitProgress缓动动画

### Phase 3: 扩展功能预研 (3周)
**目标**: 为Three.js扩展预留技术预研

**触发条件**:
- Shader Park性能达到瓶颈
- 需要更复杂的3D几何操作

**Week 5-7**:
- [ ] Three.js技术预研（可选）
- [ ] 多Pass渲染策略设计
- [ ] 性能基准对比测试

### Phase 4: 视觉效果优化 (2周)
**目标**: 基于Shader Park约束优化视觉效果

**Week 8-9**:
- [ ] 薄壳材质系统完善
- [ ] 边界发光效果优化
- [ ] 分区线调色节奏改进
- [ ] 背景噪声动态平衡

### Phase 5: 性能优化与验收 (1周)
**目标**: 达到性能KPI指标

**Week 10**:
- [ ] 移动端性能优化（iPhone 12/A14基准）
- [ ] 帧率稳定性测试
- [ ] 内存使用优化
- [ ] 最终验收测试

## 10. 质量保证

### 10.1 视觉质量检查
- [ ] 分形结构合理性验证
- [ ] 动画流畅性测试
- [ ] 色彩一致性检查
- [ ] 材质真实感评估

### 10.2 性能基准测试
- [ ] iPhone 12/A14基准：≥30FPS稳定
- [ ] 桌面端：≥45FPS平均
- [ ] DPR≤2约束测试
- [ ] 内存使用≤100MB
- [ ] 1.3M像素渲染测试

### 10.3 用户体验测试
- [ ] 交互直观性验证
- [ ] 学习曲线评估
- [ ] 无障碍访问支持
- [ ] 多平台兼容性测试

---

## 结语

本视觉方案基于Anicca项目现有的Shader Park + React技术架构，提供了一套切实可行的分形视觉系统MVP实现路径。方案严格遵循技术约束，专注单管线渲染策略，确保在移动端DPR≤2的性能约束下提供流畅的交互体验。

**核心承诺**:
- **技术可行性**: 基于现有Shader3Canvas组件和shader3.ts实现
- **性能保证**: iPhone 12/A14基准，≥30FPS稳定
- **参数具体**: 所有参数都有明确范围和单位
- **风险可控**: 移除了不切实际的Compute Shader等概念

通过三段式编舞（萌生/分裂/稳态）和薄壳式透明策略，在Shader Park约束下实现"弥散错觉"效果，为用户提供一个既理性又富有禅意美学的交互式视觉体验。